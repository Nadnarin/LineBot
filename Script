const LINE_TOKEN = 'YOUR_LINE_CHANNEL_ACCESS_TOKEN';
const FOLDER_ID = 'YOUR_GOOGLE_DRIVE_FOLDER_ID';

function doPost(e) {
  const json = JSON.parse(e.postData.contents);

  if (json.events && json.events.length > 0) {
    const event = json.events[0];
    const userId = event.source.userId;

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô message event
    if (event.type === 'message' && event.message.type !== 'text') {
      const messageId = event.message.id;
      const fileName = 'linefile_' + new Date().getTime();

      // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å LINE server
      const fileResponse = UrlFetchApp.fetch(`https://api-data.line.me/v2/bot/message/${messageId}/content`, {
        headers: { Authorization: 'Bearer ' + LINE_TOKEN },
        muteHttpExceptions: true
      });

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô Google Drive
      const blob = fileResponse.getBlob();
      const folder = DriveApp.getFolderById(FOLDER_ID);
      const createdFile = folder.createFile(blob.setName(fileName));

      // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö
      const replyMsg = {
        replyToken: event.replyToken,
        messages: [
          { type: 'text', text: 'üìÇ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß: ' + createdFile.getUrl() }
        ]
      };

      UrlFetchApp.fetch('https://api.line.me/v2/bot/message/reply', {
        method: 'post',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + LINE_TOKEN
        },
        payload: JSON.stringify(replyMsg)
      });
    }
  }

  return ContentService.createTextOutput('OK');
}
